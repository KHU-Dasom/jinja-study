# Kernel
![커널 이미지](data:image/png;base64,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)  
커널은 컴퓨터 하드웨어와 프로세스를 잇는 인터페이스이다.  
- 메모리 관리
- 프로세스 관리
- 디바이스 드라이버
- 시스템 콜 및 보안
커널은 메모리에 상주하며 CPU에 명령을 내린다.  

시스템에서 실행되는 코드는 커널모드 혹은 사용자 모드로 실행된다.  

# User Mode
프로그램이 부팅될 때에 프로그램은 User Mode로 실행된다.  
User Mode 프로그램이 실행될 때에 OS에 의하여 프로세스와 가상 메모리가 생성된다.  
User Mode를 사용한 프로그램은 시스템 자원에 직접 접근할 수 없다.  
시스템 자원에 접근하기 위해서 System Call을 통하여 Kernel Mode로 전환하고 자원을 요청한다.  
# Kernel Mode (Privileged Mode)
프로그램이 하드웨어에 마음대로 접근하는 것을 제어한다.  
User Mode의 프로그램이 하드웨어에 접근하고 싶을 때, System Call을 이용하여 Kernel Mode로 전환하고 하드웨어에 접근한 후에, CPU는 다시 User Mode로 전환한다.    
![User Mode Kernel Mode](https://mblogthumb-phinf.pstatic.net/20140312_196/4717010_1394617510658MKf0q_JPEG/1_10_UserToKernelMode.jpg?type=w2)  
User Mode와 Kernel Mode는 CPU에 존재하는 Mode Bit를 통하여 구분한다.  
Mode Bit가 0이면 Kernel Mode, 1이면 User Mode이다.  

커널 모드는 모든 프로세스가 하나의 가상 메모리를 공유하는 반면, 사용자 모드는 모든 프로세스가 각각의 가상 메모리 공간을 가진다.  
System Crash가 커널 모드에서 발생하면 모든 것을 다운되게 만들지만 사용자 모드에서의 System Crash는 세션을 재실행시키는 것으로 복구할 수 있다.  

즉 사용자 모드가 더 System Crash에 더 안전하고, 잘못된 하드웨어 호출로부터 안전하여 대부분의 프로그램은 사용자 모드에서 실행된다.  

## 스위칭
사용자 모드에서 커널 모드로 전환하기 위한 과정은 다음과 같다. (ARM 프로세스)  
1. Glibc 라이브러리의 함수를 호출한다.
2. Glibc 라이브러리는 각기 다른 아키텍쳐마다 적절한 방법의 System Call을 호출하는 방법을 알고 있어서 시스템 콜 도입을 위한 적절한 ABI(Application Binary Interface)를 전달한다. 
3. Glibc는 해당 아키텍쳐의 SWI instruction(Software Interrupt Instruction)를 호출하고 CPSR 레지스터의 Mode bit와 벡터 주소를 0x08로 업데이트 함으로서 Supervisor 모드로 전환한다.
4. MMU(Memory Management Unit)은 이제 커널 가상 메모리의 접근과 실행을 허용한다.
5. Vector 주소 0x08로부터 프로세스는 SW Interrupt handler routine(vector_swi())을 호출한다.
6. vector_swi에서 SCNO(System Call Number)를 SWI 명령에 따라 가져오고 적절한 system call를 호출한다.
7. 시스템 콜이 호출되고 나서 사용자 공간의 레지스터는 사용자 모드를 호출하기 이전으로 복구된다.

# System Call
사용자 프로그램이 운영 체제의 커널이 제공하는 서비스에 접근하기 위한 인터페이스이다.  
UNIX 기반의 시스템에서는 주로 C library(glibc)를 통하여 호출할 수 있다. [참조](https://manpages.ubuntu.com/manpages/xenial/en/man2/syscalls.2.html)   

# Interrupt
CPU가 프로그램을 실행할 때에 예외 상황이 발생하여 처리가 필요한 경우 마이크로프로세서에게 알려 처리를 할 수 있도록 하는 것이다.  
마이크로프로세서는 인터럽트를 감지하면 실행중인 기계어 코드를 중단하고 인터럽트 처리를 위한 ISR(Interrupt Service Routine)을 수행한다.  
이때 ISR은 현재 진행중인 프로그램의 레지스터를 스택에 옮겨두고 해당 일을 수행한다.  

일반적으로 모든 예외 상황을 인터럽트라고 통칭하지만 Trap과 Interrupt로 구분하기도 한다.  

## Interrupt
인터럽트는 하드웨어에서 발생하는 것으로 비동기적이다.  
Keyboard Interrupt나 I/O Interrupt, 네트워크 패킷 수신 Interrupt 등이 있다.

## Trap
트랩은 사용자 프로그램에서 OS의 기능을 사용하기 위해 발생한다.  
소프트웨어가 생성하는 인터럽트로 0으로 나누거나 잘못된 메모리 액세스 등의 오류로 인하여 혹은 OS에 대한 요청을 할때에 발생한다.  
발생 시점이 프로그램의 일정한 지점이기 때문에 동기적이다.  


