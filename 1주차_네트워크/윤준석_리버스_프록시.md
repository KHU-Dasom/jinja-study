# **ë¦¬ë²„ìŠ¤ í”„ë¡ì‹œ**

## **ğŸ“¡ í”„ë¡ì‹œ ì„œë²„ë€?**

- í”„ë¡ì‹œ ì„œë²„ëŠ” í†µìƒì ìœ¼ë¡œ í¬ì›Œë“œ í”„ë¡ì‹œ ì„œë²„ë¥¼ ëœ»í•¨.
- í¬ì›Œë“œ í”„ë¡ì‹œ ì„œë²„ëŠ” í´ë¼ì´ì–¸íŠ¸ì™€ ì„œë²„ ì‚¬ì´ì— ìœ„ì¹˜í•˜ì—¬ í´ë¼ì´ì–¸íŠ¸ì˜ ìš”ì²­ì„ ì„œë²„ì— ì „ë‹¬í•˜ê³  ì„œë²„ì˜ ì‘ë‹µì„ í´ë¼ì´ì–¸íŠ¸ì— ì „ë‹¬í•˜ëŠ” ì—­í• ì„ í•¨.
- í”„ë¼ì´ë¹— ë„¤íŠ¸ì›Œí¬ì™€ í¼ë¸”ë¦­ ì¸í„°ë„· ì‚¬ì´ì˜ ì¤‘ê°œì ì—­í• ì„ í•¨.

![forward_proxy_flow](https://www.cloudflare.com/img/learning/cdn/glossary/reverse-proxy/forward-proxy-flow.svg)

- í´ë¼ì´ì–¸íŠ¸ëŠ” í”„ë¡ì‹œ ì„œë²„ë¥¼ "ì„œë²„"ë¡œ ì¸ì‹í•˜ê³ , ì„œë²„ëŠ” í”„ë¡ì‹œ ì„œë²„ë¥¼ "í´ë¼ì´ì–¸íŠ¸"ë¼ê³  ì¸ì‹í•¨

### **ğŸ‘ğŸ» í¬ì›Œë“œ í”„ë¡ì‹œ ì„œë²„ì˜ ì¥ì **

- ìºì‹±
  - í´ë¼ì´ì–¸íŠ¸ì™€ ì„œë²„ ì‚¬ì´ì—ì„œ ì¤‘ê°œì ì—­í• ì„ í•˜ë©° ì „ë‹¬í•˜ëŠ” ë‚´ìš©ë“¤ì„ ìºì‹±í•¨.
  - CDN ì„œë²„ì™€ ìœ ì‚¬í•˜ê²Œ ìºì‹±ì„ í†µí•´ ë¹ ë¥¸ ì‘ë‹µì„ í•  ìˆ˜ ìˆìŒ.
  - ìì£¼ ìš”ì²­í•˜ëŠ” ë¦¬ì†ŒìŠ¤ë¥¼ ìºì‹±í•´ë‘ë©´ ë¶ˆí•„ìš”í•œ ì™¸ë¶€ ìš”ì²­ì„ ì¤„ì¼ ìˆ˜ ìˆê³  ë„¤íŠ¸ì›Œí¬ ë³‘ëª© í˜„ìƒì„ ë°©ì§€í•´ì¤Œ.

- ë³´ì•ˆ
  - í¬ì›Œë“œ í”„ë¡ì‹œ ì„œë²„ë¥¼ í†µí•´ ì„œë²„ì— ìš”ì²­ì„ ë³´ë‚´ë©´, í´ë¼ì´ì–¸íŠ¸ì˜ ìš”ì²­ ì •ë³´ë¥¼ ìˆ¨ê¸¸ ìˆ˜ ìˆìŒ.
  - ì„œë²„ ì…ì¥ì—ì„œëŠ” í”„ë¡ì‹œ ì„œë²„ë¥¼ ê±°ì³ ìš”ì²­ì´ ì˜¤ê¸° ë•Œë¬¸ì— í´ë¼ì´ì–¸íŠ¸ì˜ ì •ë³´ë¥¼ ì•Œ ìˆ˜ ì—†ìŒ. (IP ì£¼ì†Œ, User-Agent ë“±)

### **ğŸ” í¬ì›Œë“œ í”„ë¡ì‹œ ì„œë²„ ì‚¬ìš© ì˜ˆì‹œ**

- íŠ¹ì • ì‚¬ì´íŠ¸ ì ‘ì† ì œí•œ
  - í”„ë¡ì‹œ ì„œë²„ë¥¼ í†µí•´ ìš”ì²­ì„ ë³´ë‚´ê¸° ë•Œë¬¸ì—, í”„ë¡ì‹œ ì„œë²„ì—ì„œ ìš”ì²­ì„ ì œí•œí•  ìˆ˜ ìˆìŒ.
  - ì˜ˆë¥¼ ë“¤ì–´, íŠ¹ì • IP ì£¼ì†Œë‚˜ User-Agentë¥¼ ì°¨ë‹¨í•˜ê±°ë‚˜, íŠ¹ì • ì‹œê°„ëŒ€ì—ë§Œ ìš”ì²­ì„ ë°›ì„ ìˆ˜ ìˆìŒ.

## **ğŸ”¥ ë¦¬ë²„ìŠ¤ í”„ë¡ì‹œ ì„œë²„ë€?**

- í¬ì›Œë“œ í”„ë¡ì‹œì™€ ë‹¤ë¥´ê²Œ í•˜ë‚˜ ì´ìƒì˜ ì›¹ ì„œë²„ ì•ì— ìœ„ì¹˜í•˜ì—¬ í´ë¼ì´ì–¸íŠ¸ì˜ ìš”ì²­ì„ ê°€ë¡œì±„ëŠ” ì„œë²„ì„.
- í´ë¼ì´ì–¸íŠ¸ê°€ ì„œë²„ì— ìš”ì²­ì„ ë³´ë‚´ë©´ ë¦¬ë²„ìŠ¤ í”„ë¡ì‹œ ì„œë²„ê°€ ìš”ì²­ì„ ê°€ë¡œì±„ê³ , ì›¹ ì„œë²„ì— ìš”ì²­ì„ ì „ë‹¬í•¨.

![reverse_proxy_flow](https://www.cloudflare.com/img/learning/cdn/glossary/reverse-proxy/reverse-proxy-flow.svg)

- í´ë¼ì´ì–¸íŠ¸ëŠ” ì„œë²„ë¥¼ "ì„œë²„"ë¡œ ì¸ì‹í•˜ê³ , ì„œë²„ëŠ” ë¦¬ë²„ìŠ¤ í”„ë¡ì‹œ ì„œë²„ë¥¼ "í´ë¼ì´ì–¸íŠ¸"ë¼ê³  ì¸ì‹í•¨

### **ğŸ‘ğŸ» ë¦¬ë²„ìŠ¤ í”„ë¡ì‹œ ì„œë²„ì˜ ì¥ì **

- ë¡œë“œ ë°¸ëŸ°ì‹±
  - ìˆ˜ë°±ë§Œ ì´ìƒì˜ ì‚¬ìš©ìë¥¼ ê°€ì§„ ì„œë¹„ìŠ¤ì˜ ê²½ìš° ë‹¨ì¼ ì„œë²„ë¡œëŠ” ëª¨ë“  íŠ¸ë˜í”½ì„ ì²˜ë¦¬í•˜ì§€ ëª»í•  ìˆ˜ ìˆìŒ.
  - ë¦¬ë²„ìŠ¤ í”„ë¡ì‹œ ì„œë²„ë¥¼ ì‚¬ìš©í•˜ë©´ ì—¬ëŸ¬ ëŒ€ì˜ ì„œë²„ë¥¼ ë‘ê³  ë¡œë“œ ë°¸ëŸ°ì‹±ì„ í†µí•´ íŠ¸ë˜í”½ì„ ë¶„ì‚°ì‹œí‚¬ ìˆ˜ ìˆìŒ.
  - ìš”ì²­ì„ ë°›ì€ ì„œë²„ê°€ ê³¼ë¶€í•˜ ìƒíƒœë¼ë©´ ë‹¤ë¥¸ ì„œë²„ë¡œ ìš”ì²­ì„ ì „ë‹¬í•¨.
- ê³µê²© ë³´í˜¸
  - ë¦¬ë²„ìŠ¤ í”„ë¡ì‹œë¥¼ ì‚¬ìš©í•˜ë©´ ì›¹ ì‚¬ì´íŠ¸ ë˜ëŠ” ì„œë¹„ìŠ¤ì—ì„œ ì›ë³¸ ì„œë²„ì˜ IP ì£¼ì†Œë¥¼ ê³µê°œí•˜ì§€ ì•Šì•„ë„ ë¨.
  - DDOS ê³µê²© ë“±ì˜ ìœ„í˜‘ìœ¼ë¡œë¶€í„° ì›ë³¸ ì„œë²„ë¥¼ ë³´í˜¸í•  ìˆ˜ ìˆìŒ.
- ìºì‹±
  - ë¦¬ë²„ìŠ¤ í”„ë¡ì‹œ ë˜í•œ í¬ì›Œë“œ í”„ë¡ì‹œì™€ ìœ ì‚¬í•˜ê²Œ ìºì‹± ê¸°ëŠ¥ì„ ì œê³µí•  ìˆ˜ ìˆìŒ.
  - ì„œë²„ì— ìš”ì²­ë˜ëŠ” ì£¼ê¸°ê°€ ì§§ì€ ë¦¬ì†ŒìŠ¤ë“¤ì„ ë¦¬ë²„ìŠ¤ í”„ë¡ì‹œ ì„œë²„ì— ìºì‹±í•´ë‘ë©´ ì„œë²„ì˜ ë¶€í•˜ë¥¼ ì¤„ì¼ ìˆ˜ ìˆìŒ.
- SSL/TLS ì•”í˜¸í™”
  - ë¦¬ë²„ìŠ¤ í”„ë¡ì‹œ ì„œë²„ë¥¼ ì‚¬ìš©í•˜ë©´ ì›¹ ì„œë²„ì™€ í´ë¼ì´ì–¸íŠ¸ ì‚¬ì´ì— SSL/TLS ì•”í˜¸í™”ë¥¼ ì ìš©í•  ìˆ˜ ìˆìŒ.
  - ì›¹ ì„œë²„ëŠ” SSL/TLS ì•”í˜¸í™”ë¥¼ ì§€ì›í•˜ì§€ ì•Šì•„ë„ ë¨.

## **NginXë¡œ ë¦¬ë²„ìŠ¤ í”„ë¡ì‹œ ì„œë²„ êµ¬ì¶•í•˜ê¸°**

- nginxë¡œ ë¡œë“œë°¸ëŸ°ì‹± ê¸°ëŠ¥ì„ í•˜ëŠ” ê°„ë‹¨í•œ ë¦¬ë²„ìŠ¤ í”„ë¡ì‹œ ì„œë²„ë¥¼ êµ¬ì¶•í•´ë³´ì•˜ìŒ.

### **http ì„œë²„**

- ê°„ë‹¨í•œ http ì„œë²„.
- ì„œë²„ êµ¬ë¶„ì„ ìœ„í•´ uuidë¥¼ ìƒì„±í•˜ê³  ë³´ì—¬ì£¼ëŠ” ì„œë²„ì„.

```golang
package main

import (
		"net/http"
		"github.com/google/uuid"
		"github.com/labstack/echo"
		"github.com/labstack/echo/middleware"
	   )

func main() {
	e := echo.New()

	e.Use(middleware.Logger())
	e.Use(middleware.Recover())

	e.GET("/", hello)

	e.Logger.Fatal(e.Start(":3000"))
}

func hello(c echo.Context) error {
	u, err := uuid.NewRandom()
	if err != nil {
		panic(err)
	}
	return c.String(http.StatusOK, u.String())
}
```

### **NginX ì„¤ì •**

- `nginx.conf` íŒŒì¼ ì„¤ì •

```nginx
worker_processes 4;

events { worker_connections 1024; }

http {
	upstream echo {
		least_conn;
		server server1:3000 weight=10 max_fails=3 fail_timeout=30s;
		server server2:3000 weight=10 max_fails=3 fail_timeout=30s;
		server server3:3000 weight=10 max_fails=3 fail_timeout=30s;
		server server4:3000 weight=10 max_fails=3 fail_timeout=30s;
		server server5:3000 weight=10 max_fails=3 fail_timeout=30s;
		server server6:3000 weight=10 max_fails=3 fail_timeout=30s;
	}

	server {
		listen 80;

		location / {
			proxy_pass http://echo;
			proxy_http_version 1.1;
			proxy_set_header Upgrade $http_upgrade;
			proxy_set_header Connection 'upgrade';
			proxy_set_header Host $host;
			proxy_cache_bypass $http_upgrade;
		}
	}
}
```

- nginxëŠ” ì´ë²¤íŠ¸ ê¸°ë°˜ìœ¼ë¡œ ë™ì‘í•¨.
- `upstream` ì„¤ì • -> upstream ì•ˆì˜ ì„œë²„ë“¤ì—ê²Œ requestë¥¼ ë³´ëƒ„.
- `least_conn`: ì—°ê²°ëœ ì»¤ë„¥ì…˜ì´ ê°€ì¥ ì ì€ ì„œë²„ì—ê²Œ requestë¥¼ ë³´ëƒ„. ê·¸ ì´ì˜ ë°©ì‹ìœ¼ë¡œëŠ”
  - `round-robin(default)`: ë¼ìš´ë“œë¡œë¹ˆìœ¼ë¡œ ë¶„ë°°
  - `hash`: í•´ì‹œê°’ì„ ê¸°ë°˜ìœ¼ë¡œ ë¶„ë°°
  - `ip_hash`: í´ë¼ì´ì–¸íŠ¸ì˜ ipë¥¼ ê¸°ë°˜ìœ¼ë¡œ ë¶„ë°°
  - `random`: ëœë¤ìœ¼ë¡œ ë¶„ë°°
  - `least_time`: ê°€ì¥ ë¹ ë¥¸ ì‘ë‹µì‹œê°„ì„ ê°€ì§„ ì„œë²„ì—ê²Œ requestë¥¼ ë³´ëƒ„.

### **Docker image ë¹Œë“œ**

- `echo/Dockerfile`

```Dockerfile
FROM golang:1.18.1-alpine

ENV GO111MODULE=on

WORKDIR /src

COPY . /src

RUN go build -o main

EXPOSE 3000
CMD ["./main"]
```

` $ docker build -t echo .`

- `nginx/Dockerfile`

```Dockerfile
FROM nginx:1.15-alpine

COPY nginx.conf /etc/nginx/nginx.conf
```

` $ docker build -t nginx_server .`

### **Docker compose**

- `docker-compose.yml`

```yaml
version: '3.1'

networks:
  lb_network:
    driver: bridge

services:
  nginx:
    container_name: nginx_server
    image: nginx_server
    restart: always
    ports:
      - "8080:80"
    networks:
      - lb_network
    depends_on:
      - server1
      - server2
      - server3
      - server4
      - server5
      - server6
  server1:
    container_name: server1
    image: echo
    restart: always
    expose:
      - "3000"
    networks:
      - lb_network

  server2:
    container_name: server2
    image: echo
    restart: always
    expose:
      - "3000"
    networks:
      - lb_network

  server3:
    container_name: server3
    image: echo
    restart: always
    expose:
      - "3000"
    networks:
      - lb_network

  server4:
    container_name: server4
    image: echo
    restart: always
    expose:
      - "3000"
    networks:
      - lb_network

  server5:
    container_name: server5
    image: echo
    restart: always
    expose:
      - "3000"
    networks:
      - lb_network

  server6:
    container_name: server6
    image: echo
    restart: always
    expose:
      - "3000"
    networks:
      - lb_network
```

- docker network ë‚´ë¶€ì—ì„œ ìì²´ì ìœ¼ë¡œ DNS ì„œë²„ë¥¼ ê°€ì§€ê³  ìˆê¸° ë•Œë¬¸ì— ì»¨í…Œì´ë„ˆ ì´ë¦„ìœ¼ë¡œ ì ‘ê·¼ ê°€ëŠ¥í•¨.

### **ê²°ê³¼**

![docker-compose](https://user-images.githubusercontent.com/39883609/201889936-fbf96981-977f-44c5-ae6a-25680ec79ad9.png)

- docker ì»¨í…Œì´ë„ˆë“¤ê³¼ ë„¤íŠ¸ì›Œí¬ê°€ ìƒì„±ëœ ê²ƒì„ ë³¼ ìˆ˜ ìˆìŒ

![load-balancing](https://user-images.githubusercontent.com/39883609/201891033-53c0fb7f-1935-4fa7-a500-c6c6db0de874.png)

- ì•ì—ì„œ ìƒì„±í•œ http ì„œë²„ëŠ” ì„œë²„ ìƒì„± ì‹œ ê³ ìœ í•œ uuid ê°’ì„ ë°›ì•„ `/` ê²½ë¡œë¡œ ìš”ì²­ì´ ì˜¤ë©´ í•´ë‹¹ uuidë¥¼ ë°˜í™˜í•˜ëŠ” ì„œë²„ì„.
- nginx ì„œë²„ì— ì ‘ê·¼í•˜ë©´ nginx ì„œë²„ëŠ” upstream ì„¤ì •ì— ë”°ë¼ http ì„œë²„ë¡œ ë¡œë“œë°¸ëŸ°ì‹±í•˜ì—¬ requestë¥¼ ë³´ëƒ„.
